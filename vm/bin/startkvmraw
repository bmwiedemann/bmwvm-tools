#!/bin/sh
if [ -z "$n" ] ; then
        n=$(whoami|perl -pe s/vm//)
	n2=`printf "%02i" $n`
fi
if [ "$1" = "stop" ] ; then
	echo system_powerdown > `kvmmanage $n`
	exit 0
fi

p=/vm/
h=$HOME
prefix=`cat /home/uml1/prefix`
vpnip=${prefix}1
nice=0
cpumask=fffffffe
#linux=${linux:-/vm/bin/linux}
#image=${image:-$p/root_fs_suse103}
vgname=`cat /etc/vbox/vgname`
smp=4
rootif=ide
vncopts="$vpnip:$n"
image=${image:-/dev/mapper/$vgname-vm$n}
if [ ! -e $image ] ; then
	sudo /vm/bin/losetup.pl $n
	image=/dev/loop$n
fi
rw=1
options=${options:-/vm/vm$n/options}
mem=${mem:-64M}
con=
extra=
persistentcow=0
bg=" -daemonize "


if [ -z "$n" ] ; then
	echo usage: n=1 $0
	echo "  other options: i=0 options=/home/uml$n/options image= "
	exit 1
fi

test -e $options && . $options

if [ $vnc ] ; then
	bg=" -vnc $vncopts $bg"
	#-k de
else
	bg=" -nographic $bg"
fi
if [ $i ] ; then con="" ; bg="" ; 
#else exec <&-; exec 2>&-;
fi


swap=swap$n
cd $h
if [ $persistentcow = 0 ] ; then
	rm -f cow$n
fi
#rm -f $swap
#dd if=/dev/zero of=$swap bs=1k count=1 seek=99999 2>/dev/null
#chmod 600 $swap
#/sbin/mkswap $swap
#cd $p
eth=$(printf FE:FD:00:00:%.2x:%.2x $(echo $prefix|cut -d. -f3) $n)
test -n "$rw" || cow=$h/cow$n,
#sudo /vm/bin/losetup.pl $n
touch /vm/vm$n/.vmstart

#eval $linux root=/dev/ubda1 eth0=daemon,$eth,unix,/var/run/vde.ctl/ctl ubd0=$cow$image umlid=$n umid=uml$n mem=$mem $extra  $con con=pts hostfs=$h/$n $* $bg

mem=`perl -e '$_=shift;s/m//i; print' $mem`
exec /usr/bin/nice -n $nice /usr/bin/taskset $cpumask kvm -name vm$n -smp $smp -net vde -net nic,macaddr=$eth$netopt -drive file=$image,if=$rootif,index=0,media=disk,boot=on -m $mem -monitor pty $extra $bg
# -serial telnet::${n}223,server,nowait -monitor tcp:127.0.0.1:${n}224,server,nowait

